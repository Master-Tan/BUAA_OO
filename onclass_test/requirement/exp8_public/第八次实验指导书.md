# 面向对象第八次实验指导书

## 实验仓库

> 公共信息发布区：[exp8_public](http://gitlab.oo.buaa.edu.cn/2022_public/experiment/exp8_public)。
>
> 个人仓库：`oo_homework_2022/homework_2022_你的学号_exp_8`。
>
> 请同学们作答完成后，将 json 文件与代码**提交到个人仓库**，并将 json 文件内容**填入内容提交区**，再在本页面下方选择对应的 `commit`，最后**点击最下方的按钮进行提交**。详细的提交过程请参见**_提交格式_**章节。

## 实验目的

1. 学习 UML 类图、顺序图和状态图的基本知识；
2. 训练理解 UML 类图、顺序图和状态图的能力；
3. 学习根据 UML 模型的一致性检查规则对 UML 模型进行整体分析。

## 知识要点

### UML 中的不一致性

- UML 为建模者提供了多种模型图 (diagram)，每个图都规定了所能描述的元素类别和相关描述规则。建模者通过可视化的方式来构造具体的模型图，UML 建模工具则基于 UML 语言的定义在后台把不同图中所描述的元素进行连接，从而形成 UML 模型。虽然 UML 本身定义了不同模型图中所描述元素之间的链接关系，但并不是所有的 UML 建模工具都能够进行充分的检查。因此，实践中 UML 模型中存在无效、甚至不一致问题仍然具有一定的普遍性。无效或不一致的模型本身带有缺陷，如果不能及时检测和修复，会最终成为代码实现中的 bug。因此，检测 UML 模型中的不一致性是一个需要重视的问题。
- UML 不同模型图之间的不一致性问题比较复杂，仍然是一个学术研究问题。课程主要参考 StarUML 官网所列举的 Validation Rules，以及根据 UML 语言定义梳理了几条比较关键的检查规则——例如给定一个顺序图，其中涉及某个对象 (UMLAttribute)，而该对象没有在类图中进行定义（即未定义其类型）。

### 检查规则

下文给出本次实验可供参考的不一致性检查规则。

- 类图和顺序图之间的一致性检查
  - 如果两个对象之间有消息传递，则这两个对象所属的类之间应有关联关系，否则这两个对象不可能“认识”对方；
  - 接收消息的对象所属的类中应有与该消息相匹配的操作，并且该操作对于发送相应消息的对象而言可见 (visible)；
  - 顺序图中消息涉及的参数个数、类型和次序，应与相应类中相匹配操作的参数个数、类型和次序一致。
- 状态图自身、类图与其状态图之间的一致性检查
  - 状态图中的每一个触发事件 (trigger)，在相应类中必须有对应的操作（操作名与触发事件名称相同）;
  - 状态中的动作表达式如果是一个操作调用，则意味状态图所属类中必须定义了相应的操作，且状态动作的参数类型和次序必须与相对应操作的参数类型和次序一致；
  - 对于状态图来说，如果从某个源状态出发的两个状态迁移所对应的触发条件（包括 trigger 和 guard）相同，则产生不确定性，一旦相应的 trigger 事件发生且 guard 条件满足，不知道该触发哪个迁移，因此不允许出现这样的不确定性。
- 顺序图和状态图的一致性检查
  - 针对顺序图中每个对象生命线的入消息，相应对象都处于可以响应该消息的状态中。

上述规则仅供参考，不限于从以上规则出发考虑问题。

## 实验任务

在 Pre 2 中，我们建立了一个冒险家模型。回忆一下当时的情境：在遥远的大陆上有一个冒险家协会，协会统一管理所有的冒险家与装备。每个冒险家都拥有一个背包，背包里带着各式各样的装备。其中装备有很多种，可以是功能不同的药水（如耐寒药剂、防潮药剂等），也可以是各式各样的武器（单手剑、双手剑等）。

根据这样的情境，我们建立了对应的类图、顺序图和状态图模型，并在后文给出。针对给出的模型实例（包括类图、顺序图和状态图），指出实例中的不一致。将发现的不一致之处逐条总结，填写改错问卷在实验页面进行提交。

### 图 1：类图

[![XsujRP.png](https://s1.ax1x.com/2022/06/09/XsujRP.png)](https://imgtu.com/i/XsujRP)

### 图 2：add equipment 场景下的顺序图

[![XsuXGt.png](https://s1.ax1x.com/2022/06/09/XsuXGt.png)](https://imgtu.com/i/XsuXGt)

### 图 3：顺序图片段 add equipment 的状态图

[![XsuOPI.png](https://s1.ax1x.com/2022/06/09/XsuOPI.png)](https://imgtu.com/i/XsuOPI)

## 填写格式

各类填写类型的格式如下：

- 类名：请严格按照类图中的大小写填写 UML 图中已经存在的类名
- 属性名：请严格按照类图中的大小写填写 UML 图中已经存在的属性名
- 关系：请填写 UML 图中存在的关系：如泛化、实现、依赖、关联、聚合、组合
- 方法：请严格按照类图中的大小写填写 UML 图中已经存在的方法名，无需填写参数，无需括号（如你觉得有必要，可以用 `类名.方法名` 的形式描述）。
- 条件：请严格按照状态图中已经给定的守护条件进行填写，不需要填写两侧的方括号。
- 场景：场景填写有两类情形，请根据所找到的场景按照如下要求填写
  - 情形 1 顺序图：填写 `在 A 下从 B 类传递消息到 C 类`，其中 A 表示消息传递的条件，B，C 表示图中出现的类名。
  - 情形 2 状态图：填写 `类 A 从状态 B 转移到状态 C`，其中 A 表示图中出现的类名，B，C 表示图中出现的状态。

## 改错问卷

1. 在类图中，\_\_\_\_\_\_\_\_\_\_\_（填写类名）的 \_\_\_\_\_\_\_\_\_\_\_（填写方法）可见性存在问题，因为存在一个\_\_\_\_\_\_\_\_\_\_\_（填写关系）的 \_\_\_\_\_\_\_\_\_\_\_（填写类名）类，该关系约束了方法的可见性。

2. 在类图中，部分类缺少 \_\_\_\_\_\_\_\_\_\_\_方法，这会导致在实际编码时无法约定这些类初始建立的条件。

3. 从类图和顺序图的一致性的角度考虑，在类图中，\_\_\_\_\_\_\_\_\_\_\_（填写类名）缺少一个方法 \_\_\_\_\_\_\_\_\_\_\_ （填写方法） ，因为在\_\_\_\_\_\_\_\_\_\_\_（填写场景）的情形下，需要调用该方法。

4. 从类图和顺序图的一致性、顺序图和状态图的一致性的角度考虑，在状态图中，\_\_\_\_\_\_\_\_\_\_\_（填写类名）调用了 \_\_\_\_\_\_\_\_\_\_\_（填写类名）中的一个方法 \_\_\_\_\_\_\_\_\_\_\_（填写方法），而根据顺序图对应子过程的消息传递方向可知，这个方法在类图中由于可见性不可被调用。

5. 从类图和顺序图的一致性的角度考虑，可以看到顺序图中允许 `CommodityManager` 向 `Adventurer` 发送消息获得背包，但是在类图中\_\_\_\_\_\_\_\_\_\_\_（填写类名）缺少到 \_\_\_\_\_\_\_\_\_\_\_（填写类名）的\_\_\_\_\_\_\_\_\_\_\_ （填写关系）关系。

6. 从类图和状态图的一致性的角度考虑，在顺序图片段 add equipment 的状态图中，对 \_\_\_\_\_\_\_\_\_\_\_ （填写方法）的描述与类图并不一致。

7. 在顺序图片段 add equipment 的状态图中，当 `trying to add` 状态即将进行状态转移且 `trying` 的值为\_\_\_\_\_\_\_\_\_\_\_时，由于 \_\_\_\_\_\_\_\_\_\_\_（填写完整条件，不含空格，顺序无关） 和 \_\_\_\_\_\_\_\_\_\_\_（填写完整条件，不含空格，顺序无关） 可能同时成立，这会导致转移具有二义性。改写从\_\_\_\_\_\_\_\_\_\_\_ （填写状态） 到 \_\_\_\_\_\_\_\_\_\_\_（填写状态）之间的转移条件，可以实现在尝试加入物品 9 次并且都失败后，进程将进入挂起状态。

8. 在类图中，我们增加一个具体场景：我们知道 Pre 2 Task 5 里冒险家可以拥有并使用冒险家，而在我们的图中，冒险者只能拥有并使用装备。我们将装备与冒险家都看做价值体，并将冒险家拥有的背包抽象为“装了多个价值体”的容器，那么为了实现上述场景，类似于 `Equipment` 类，此时的 `Adventurer` 类还需要增加一个方法 \_\_\_\_\_\_\_\_\_\_\_（填写方法），同时 \_\_\_\_\_\_\_\_\_\_\_（填写类名）中的 \_\_\_\_\_\_\_\_\_\_\_（填写属性名）属性的类型也应当改为 \_\_\_\_\_\_\_\_\_\_\_（填写类型名）。

## 提交格式

注意到每一题有标注序号，根据在实验仓库中给出的 `answer.json` 模板，将答案填写完毕后保存在个人仓库的根目录的 `answer.json` 文件内，并在 course 平台提交该 commit，**同时需要将作答内容全部写在内容提交区**。提交示例如下：

```json
{
	"1": [
		"第一题第一空内容",
		"第一题第二空内容",
		"第一题第三空内容",
		"第一题第四空内容"
	],
	"2": "第二题填空内容",
	"3": ["第三题第一空内容", "第三题第二空内容", "第三题第三空内容"],
	"4": ["第四题第一空内容", "第四题第二空内容", "第四题第三空内容"],
	"5": ["第五题第一空内容", "第五题第二空内容", "第五题第三空内容"],
	"6": "第六题填空内容",
	"7": [
		"第七题第一空内容",
		"第七题第二空内容",
		"第七题第三空内容",
		"第七题第四空内容",
		"第七题第五空内容"
	],
	"8": [
		"第八题第一空内容",
		"第八题第二空内容",
		"第八题第三空内容",
		"第八题第四空内容"
	]
}
```

## 互测细则

---

#### **全局符号表**

| 符号名称           | 含义                                                 |
| ------------------ | ---------------------------------------------------- |
| **CD**             | 提交冷却时间，两次相邻测试用例之间的最短提交时间间隔 |
| **room_num**       | 一个互测屋内的人数，一般为 7-8 人                    |
| **A_criterion**    | 进入 A 档互测屋须通过的最低样例百分比                |
| **B_criterion**    | 进入 B 档互测屋须通过的最低样例百分比                |
| **C_criterion**    | 进入 C 档互测屋须通过的最低样例百分比                |
| **A_base**         | A 档互测屋发现/被发现单个 bug 奖励/惩罚分数          |
| **B_base**         | B 档互测屋发现/被发现单个 bug 奖励/惩罚分数          |
| **C_base**         | C 档互测屋发现/被发现单个 bug 奖励/惩罚分数          |
| **A_active_coeff** | A 档互测屋的活跃度比例系数                           |
| **B_active_coeff** | B 档互测屋的活跃度比例系数                           |
| **C_active_coeff** | C 档互测屋的活跃度比例系数                           |

#### 一、 互测整体时间安排

1. 总时间：周日上午 08:00  -- 周日晚上23:00
2. 互测前置条件：互测屋分配完成（强测结束）

#### 二、互测屋机制

##### 互测屋分组规则

	互测屋分为 A、B、C 三档，每一档中可能有多个互测屋，每个互测屋有 room_num 个人，分组依据为公测的强测结果分（功能分 + 性能分）

- 通过公测强测 [A_criterion, 100%] 测试点是进入 A 档的必要不充分条件
- 通过公测强测 [B_criterion, A_criterion) 测试点是进入 B 档的必要不充分条件
- 通过公测强测 [C_criterion, B_criterion) 测试点是进入 C 档的必要不充分条件

##### 互测基准分规则

	每个等级有自身等级对应的互测基准分，即在当前等级单个 bug 的奖励或惩罚分数，A 档互测屋基准分为 A_base，B 档为 B_base，C 档为 C_base

##### 互测屋测试机制

    一个样例在确定不是 invalid 样例之后，将会用来对整个 room 内所有的代码进行测试，但是不包括提交样例的这个人（即禁止自刀）。

##### 互测屋活跃度机制

1.每档互测屋的活跃度通过在互测期间的提交测试用例数和发现 bug 数体现。

   此处的 bug 数目是 room 内总共发现的 bug 数，且是指互测结束时发现的 bug 数，不是 bug 修复阶段之后对应的 bug 数。

2.活跃度奖励分 = (该互测屋一共发现的 bug 数 - 强测发现 bug 数) * 活跃度比例系数。

   各档互测屋的活跃度比例系数分别为 A_active_coeff, B_active_coeff, C_active_coeff。

##### 互测屋信息公开机制

​	身份信息：每个互测屋内成员的身份信息将在互测结束一周以后（即 bug 修复结束阶段之后）公开。

​	测试信息：互测进行时，每隔 update_time 的时间公布该屋内有效样例 (valid) 的总数，有价值 (valuable) 样例的总数，发现的 bug 总数；互测结果后，公布成功 hack 样例的具体样例信息和实际hack结果，以每个互测屋为单位。

**互测积分公式**

	互测得分 = 找到他人bug的奖励分 - 被找到bug的惩罚分 + 活跃奖励分
	
	（bug奖励分和bug惩罚分的具体得分情况参见下文）

**互测恶意hack同质bug惩罚机制**

在互测中，对同屋同学的一处 bug 进行数量明显过多、样例相似的 hack 行为将被视为恶意 hack。此行为不仅浪费评测机资源，且存在赌分嫌疑，破坏了互测屋的秩序及课程生态环境。

因此，对于此类恶意 hack 同质 bug 的情况，课程组将在确认情况属实后酌情进行处罚，具体惩罚力度如下：

（注：以下 **hack 同质 bug 次数**不直接等同于能够被合并修复的测试点的个数。课程组会综合考虑多种情况，对数据进行全面筛查，包括但不限于对样例相似度、黑箱测试造成的对 bug 是否同质不易判断等特殊情况的筛查）。

| hack同质bug次数 | 惩罚措施        |
| --------------- | --------------- |
| <=3             | 无              |
| 4~5             | 本 bug 得分*70% |
| 6~7             | 本 bug 得分*30% |
| 8~9             | 本 bug 得分=0   |
| 10~12           | 本次互测得分=0  |
| >12             | 本次作业得分=0  |

以上惩罚扣分都将在总评中直接扣除，不会显示在课程网站前端。

课程组会根据互测具体情况，对后台数据进行扫描来发现可能的恶意 hack，并会和相关同学进行确认，但不会在系统或班级公开具体结果。

对上述情况的审查、判定及具体的处理方式相关最终解释权归课程组所有。

#### 三、测试用例的提交细则

1.**测试用例提交内容**：测试用例输入 + 期望输出

   - 输入数据为向被测程序中输入的内容，在可交互的作业中，除了数据以外，每条数据还应包含时间参数。
   - 期望输出为测试者认为的正确输出，同样地，在可交互作业中应包含时间参数。
   - 期望输出**不作为对被测程序的测试标准**。输入数据对应的正确输出以评测机的标程输出为准，测试者提交的期望输出在测试开始前将会首先与标程的输出进行对比，如果不一致，则此测试用例将被视为无效的测试用例。
   - 同一次作业中，如果如上一条所属的情况（即提交的期望输出与标程给出的输出不符）累计出现 3 次以上（不含 3 次），则直接**禁止继续提交互测数据**。该测试者将无法再提交测试用例，但其程序将依然接受同一互测屋内其他测试者的测试（即只扣分，不加分）。

2.**所有的测试用例分为3大类**：invalid (无效的测试样例)，naive (无用的测试样例)，valuable (有价值的测试样例)

   - **invalid**：样例不符合该次作业具体的测试用例提交规范，或提交的期望输出和评测机标程输出不一致。

   - **naive**：不是 invalid 样例，但是没有测出该互测屋中任何一份作业的任何一个 bug。

   - **valuable**：不是 invalid 样例，至少发现互测屋中一个 bug 的样例。其中 valuable 样例分为 solid 和 shared 两小类，将在 bug 修复阶段详细介绍。

   - naive 和 valuable 样例又合称有效 (**valid**) 样例。

     注：invalid，naive，valuable 样例在互测时便可以判断出来，shared 和 solid 的区分将在 bug 修复阶段体现。

   **bug奖励分和bug惩罚分**：

- **bug 奖励分 = 该测试者提供的样例被视为 solid 的个数 * 对应基准分 + 该测试者提供的样例被视为 shared 时对应的奖励分总和**
- **bug 惩罚分 = $未被修复的 bug 数\times\alpha+非合并修复对应的bug数+合并修复次数$。其中$\alpha=2$**

3.两次相邻测试用例之间有提交时间间隔限制，即为用例提交冷却时间——CD

4.shared（同质的）测试用例的概念及其细则

   - 同质测试用例是一个针对被测者的概念，因为有可能被测者的代码中只有一处错误，但是却被多个测试样例同时攻击了这一点，为了避免 1 个 bug 被多次扣分，我们提出了同质样例这个概念。
     进一步讲，如果某个被测者被报告了两个 bug，且该被测者**无法在一次合并 bug 修复中同时解决这两个 bug**，那么无论本 bug 在他人的程序中是否被视为同质 bug，对于本被测者而言，这仍然是两个 bug，被扣的分数按两个 bug 计算。如果被测者**能够在一次合并 bug 修复中同时修复了两个 bug**，则该 bug 对于被测者而言，视为同质测试用例，只被扣除一次分数。

   - 由于互测屋是多对多的互测模式，因此同质 bug 的分数计算比较复杂。具体细则举例说明如下：

     - 假设某被测者 A 的程序中有一个 bug，该 bug 同时被测试者 B 和测试者 C 发现。
     - 假设测试者 B 针对这个 bug，提交了 B1 和 B2 两个测试用例；测试者 C 针对这个 bug，提交了 C1、C2 和 C3 三个测试用例。这些测试用例均成功测试出了A程序中的bug。
     - 假设 A、B 和 C 所在互测屋属于 C 组，C 组对应的互测基准分为 1。
     - 假设在 bug 修复环节中，A 在一次合并 bug 修复中解决了这个 bug，使得 B 和 C 提交的五个测试用例均运行正确。
     - 则 A 被扣除 1 分，因为A的程序只存在一个 bug。
     - B 和 C 各得到 1 * 0.5 =0.5 分，因为该 bug 被 B 和 C 同时发现，bug 分数共享。bug 得分 = 基准分 * 共享比例。
     - B 的两个测试用例和 C 的三个测试用例各自均被视为同质测试用例，因为 A 在合并 bug 修复中使得这些测试用例均运行正确。
     - 但是如果 A 没有修复，或者A的修复都不成功的话， A 依然会被扣 5 个样例没有修复的分，而 B 和 C 则会得到各自提交的 2 个和 3 个样例的分。
     - 更准确地讲，根据判断同质测试用例的方法，假设一位同学在后续的 bug 修复过程中通过一次合并 bug 修复成功使得 n 个测试用例失效，那么**对这 n 个样例的提交者取并集**，集合内元素便可以认为是这一 bug 的发现者，**他们共享这一 bug 的分数**。
     - **合并修复，非合并修复的概念将在 bug 修复规则中详细介绍**。

5.测试用例特殊限制

针对每一次作业，尤其是交互式作业，限制每一个提交用例的输入数据量，用以防止暴力测试，并减轻评测机的负载。

#### 四、互测过程中助教与学生的交互

##### 举报

1. 举报通道与互测同期开放，在此期间，助教随时接受匿名举报作弊。
2. 作弊内容包括但不限于以下情况：
   
   * 在代码中做标记。
   * 在代码中故意暴露个人信息，比如明确挂出联系方式等，如果发现疑似此类情况需要向助教申报，助教判断决定是否是故意行为，并进行相应处置，最高可视为作弊，这里的最终解释权归课程组所有。
   * 使用不符合作业规定的手段编写程序。
   * 代码抄袭。
3. 接到举报后，助教会及时查看被举报的代码和相关数据情况。一经核实，若为代码抄袭，课程成绩记为不及格，若为其他作弊情况，该次作业的得分按当次作业的最低分计算。

##### bug申诉

助教在互测结束后的两天内，接受bug申诉，具体细则如下：

1.申诉直接面向助教，不面对提交样例的人。

2.申诉范围：

   以下 bug 不在申诉范围之内：

   * 实际上答案正确，但不符合输出规范的。
   * 自己无法通过一次 bug 修复解决的多个同质 bug。
   * 由于“没看清指导书”或“没看见公告”等情况而导致的 bug。
   * 由于个人原因导致的 bug（如文件编码问题、操作系统平台问题）。

   其它的 bug 可以向助教进行申诉。

3.申诉流程：

   * 学生选择一个或多个 bug 组成一次申诉。
   * 该申诉中必须附有本地运行的录屏和详细的申诉原因。
   * 提交给助教审核，3 天时间之内给出初步回复（即初步的结果和进一步确认的工作方向），5 天时间之内给出最终评判。

4.如果申诉的 bug 被助教驳回，被驳回总次数（所有作业）累计达到 5 次之后，将不再有进行 bug 申诉的机会。

##### 互测答疑

1. 互测期间，所有提问都应在本次作业对应的讨论区中提出，原则上助教不接受私人答疑，所有问题的**最终答案以课程组发布的指导书和讨论区公告为准**。
2. 互测期间，助教轮值查看本次作业讨论区中出现的问题，对异常情况及时做出响应。

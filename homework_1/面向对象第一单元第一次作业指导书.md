## 面向对象设计与构造第一次作业

___

### 第一部分：训练目标

通过对表达式结构进行建模，完成单变量多项式的括号展开，初步体会层次化设计的思想。

___

### 第二部分：预备知识

- $1、$Java 基础语法与基本容器的使用。
- $2、$扩展 BNF 描述的形式化表述。
- $3、$正则表达式或其他解析方法。

___

### 第三部分：基本概念

#### 一、基本概念的声明

* **带符号整数** **支持前导 0** 的**十**进制带符号整数（若为正数，则正号可以省略），无进制标识。如： `+02`、`-16`、`19260817`等。

* **因子**

  - **变量因子**

      - **幂函数**

          - **一般形式** 由自变量 x，指数符号 `**` 和指数组成，指数为一个**非负**带符号整数，如：`x ** +2`。
          - **省略形式** 当指数为 1 的时候，可以省略指数符号 `**` 和指数，如：`x` 。

  - **常数因子** 包含一个带符号整数，如：`233` 。

  - **表达式因子** 用一对小括号包裹起来的表达式，可以带指数，且指数为一个**非负**带符号整数，例如 `(x**2 + 2*x)**2` 。表达式的定义将在表达式的相关设定中进行详细介绍。

* **项** 由乘法运算符连接若干因子组成，如 `x * 02`。此外，**在第一个因子之前，可以带一个正号或者负号**，如 `+ x * 02`、`- +3 * x`。注意，**空串不属于合法的项**。

* **表达式** 由加法和减法运算符连接若干项组成，如： `-1 + x ** 233 - x ** 06` 。此外，**在第一项之前，可以带一个正号或者负号**，如：`- -1 + x ** 233`、`+ -2 + x ** 19260817 `。注意，**空串不属于合法的表达式**。

* **空白字符** 在本次作业中，空白字符包含且仅包含空格 `<space>`（ascii 值 32）和水平制表符 `\t`（ascii 值 9）。其他的空白字符，均属于非法字符。

  对于空白字符，有以下几点规定：

  + 带符号整数内不允许包含空白字符，注意**符号与整数之间**也不允许包含空白字符。
  + 指数运算符内不允许包含空白字符，如 `*  *` 不合法。
  + 因子、项、表达式，在不与前两条条件矛盾的前提下，可以在任意位置包含任意数量的空白字符。

#### 二、设定的形式化表述

* 表达式 $\rightarrow$ 空白项 [加减 空白项] 项 空白项 | 表达式 加减 空白项 项 空白项
* 项 $\rightarrow$ [加减 空白项] 因子 | 项 空白项 \* 空白项 因子
* 因子 $\rightarrow$​ 变量因子 | 常数因子 | 表达式因子
* 变量因子 $\rightarrow$ 幂函数
* 常数因子 $\rightarrow$​ 带符号的整数
* 表达式因子 $\rightarrow$​ '(' 表达式 ')' [空白项 指数]
* 幂函数 $\rightarrow$ 'x' [空白项 指数]
* 指数 $\rightarrow$  '\*\*' 空白项 带符号的整数
* 带符号的整数 $\rightarrow$ [加减] 允许前导零的整数
* 允许前导零的整数 $\rightarrow$ (0|1|2|…|9){0|1|2|…|9}
* 空白项 $\rightarrow$ {空白字符}
* 空白字符 $\rightarrow$ ` `（空格） | `\t`
* 加减 $\rightarrow$ '+' | '-'

其中

- `{}` 表示允许存在 0 个、1 个或多个。
- `[]` 表示允许存在 0 个或 1 个。
- `()` 内的运算拥有更高优先级，类似数学中的括号。
- `|` 表示在多个之中选择一个。
- 上述表述中使用单引号包裹的串表示字符串字面量，如 '(' 表示字符 `(`。

式子的具体含义参照其数学含义。

若输入字符串能够由“表达式”推导得出，则输入字符串合法。具体推导方法请参阅**”第一单元形式化表述说明”文档**。

除了满足上述形式化表述之外，我们本次作业的输入数据的**额外限制**请参见**第六部分：输入/输出说明 的数据限制部分**。

___

### 第四部分：题目描述

本次作业需要完成的任务为：读入一个包含加、减、乘、乘方以及括号（其中括号的深度**至多为 1 层**）的**单变量**表达式，输出**恒等变形展开所有括号后**的表达式。

在本次作业中，**展开所有括号**的定义是：对原输入表达式 $E$ 做**恒等变形**，得到新表达式 $E'$，且 $E'$ 中不含有字符 `(` 和 `)` 。

___

### 第五部分：设计建议

* 在 Java 内，不建议使用静态数组。推荐使用 `ArrayList` 、 `HashMap` 、 `HashSet` 一类的数据结构，快速管理和调配手中无序的数据。
* 对于使用一般输入手动解析的同学，处理字符串时可以考虑使用**正则表达式**，相关的 API 可以了解 `Pattern` 和 `Matcher` 类；另外也可以考虑使用**递归下降**等方法进行解析，相关教程我们会放在实验或者训练中。
* 对于每种表达式结构，可以考虑单独建一个类，把整个表达式构建为树形结构。

___

### 第六部分：输入/输出说明

#### 一、公测说明

##### 输入格式

本次作业的输入数据**仅包含一行**，表示待展开括号的表达式。

##### 读入方法

在读入时，我们要求同学们**必须使用**课程组提供的官方读入工具包。

官方读入工具包提供两种读入模式：**一般读入模式**和**预解析读入模式**。

- **一般读入模式**会从标准输入中读入输入的表达式，然后原封不动地返回给我们，其行为相当于使用 `Scanner` 从标准输入中读取一行字符串。

- **预解析读入模式**会从标准输入中读入输入的表达式，接着对该表达式**预先做一定的解析**以方便同学们之后的处理，然后我们通过调用官方包提供的方法得到**若干行**，表示解析后得到的**子表达式个数**以及**每个子表达式字符串**。其中，解析后的每个**子表达式**的格式形如  `标签 运算符 若干操作数或已有的标签` 。**标签**指的是每行字符串的唯一的 id，保证每行字符串的标签不同；**运算符**用字符串表示，涉及到的所有运算符的定义如下：

  | 运算符  | 原表达式   | 运算符字符串表示 | 操作数 |
  | ---- | ------ | -------- | --- |
  | +    | x + 1  | add      | x 1 |
  | +    | + x    | pos      | x   |
  | -    | x - x  | sub      | x x |
  | -    | - x    | neg      | x   |
  | \*   | x * x  | mul      | x x |
  | \*\* | x ** 3 | pow      | x 3 |
  | null(无运算符) | 193      | null(无运算符) | 193     |

  操作数可以是 `x`，也可以是带符号整数。保证已有标签值小于当前标签值，即已有标签在当前子表达式之前已出现。**最后**一个标签（`fn`）对应的值即为需要求解的值。

  预解析读入模式更多的例子请见**样例部分**，输入包的使用方法以及输出格式请看输入包使用文档。

##### 输出格式

输出包括**两行**，第一行是**设置官方包读入模式后自动输出的标签**， 第二行表示展开括号之后的表达式。

##### 数据限制

- 输入表达式**一定满足**基本概念部分给出的**形式化描述**。
- 输入表达式中**至多包含1层括号**。
- 对于规则 “指数 $\rightarrow$  \*\* 空白项 带符号的整数” ，我们保证**此处的带符号整数中不会出现 - 号**，且保证**输入、计算过程中和最终计算结果得到的指数最大不超过 8**。
- 输入表达式的**有效长度**至多为 100 个字符。其中输入表达式的**有效长度**指的是输入表达式去除掉所有**空白符**后剩余的字符总数。
- 输出的结果的**有效长度**至多为 10000 个字符，如果超过该限制，那么该输出结果将会被判为错误（保证按照基准思路设计的程序满足要求）。

##### 基准思路

这里介绍一个完成本次作业的基准思路，按照本思路实现的程序，可以保证**公测**中的输出不会超过长度限制。在此基础上，你还可以进行力所能及的优化。

- 对于形如 $(\sum\limits_i a_i) + (\sum\limits_j b_j)$ 的部分，将其展开为 $\sum\limits_i a_i + \sum\limits_j b_j$ 。
- 对于形如 $(\sum\limits_i a_i) - (\sum\limits_j b_j)$ 的部分，将其展开为 $\sum\limits_i a_i + \sum\limits_j (-b_j)$ 。

- 对于形如 $(\sum\limits_i a_i) \times (\sum\limits_jb_j)$ 的部分，将其展开为 $\sum\limits_i\sum\limits_ja_ib_j$ ，且不需要进行同类项的合并。
- 对于形如 $a^b$ 的部分，若 $a$ 含有括号，则将其展开为 $a \times a \times a... \times a$，共有 $b$ 个 $a$ ，接着使用第三条的思路进行展开。

##### 判定模式

本次作业中，对于每个测试点的判定分为**正确性判定**和**性能判定**，并会根据**所选的读入模式**对得分进行修正。其中，正确性判定为 80 分，性能判定部分为 20 分，二者之和为总分。对于使用了**预解析读入模式**的同学，其最后得分会在原始分数基础上乘以 0.9。

注意：**获得性能分的前提是，在正确性判定环节被判定为正确**。如果被判定为错误，则性能分部分为0分。

正确性判定：

- 输出的表达式须符合表达式的**形式化描述**、**不能包含括号**且与原表达式**恒等**。
- 本次作业中对于恒等的定义：设 $f(x)$ 的定义域为 $D_1$，$D_1$ 包含于 $R$，$g(x)$ 的定义域为 $D_2$，$D_2$ 包含于 $R$，对任意 $x\in D_1\cap D_2$，$f(x)=g(x)$ 成立。

性能判定：

- 在本次作业中，性能分的唯一评判依据是**输出结果的有效长度**，有效长度的定义在**数据限制部分**已经给出。

- 设某同学给出的**正确答案**的有效长度为 $L_p$ ，目前**所有人**给出的正确答案中有效长度**最小的**为 $L_{min}$ 。

  记 $x = \frac{L_p}{L_{min}}$ ，则该同学**性能分百分比**为：

  $$
  r(x)= 100 \% \cdot
  \begin{cases}
  1 & x = 1 \\\\
  -31.8239x^4+155.9038x^3-279.2180x^2+214.0743x-57.9370 & 1 < x \leq 1.5 \\\\
  0 & x > 1.5
  \end{cases}
  $$

  举例来说，就是这样：

  | $x$    | $r\left(x\right)$ |
  |:------:|:-----------------:|
  | $1.0$  | $100.0\%$         |
  | $1.05$ | $79.9\%$          |
  | $1.1$  | $60.5\%$          |
  | $1.2$  | $29.0\%$          |
  | $1.3$  | $10.9\%$          |
  | $1.4$  | $4.5\%$           |
  | $1.5$  | $0.0\%$           |

  该答案得到的性能分即为 $r(x)\times 20$。

#### 二、互测说明

互测时，你可以通过提交**输入数据**和**期望得到的正确的输出**，该组数据会被用来测试同一个互测房间中的其他同学的程序。

**注意** 即使你使用了预解析读入，你提供的输入也应当是**原始表达式**，而非预解析后的格式。例如对于输入 `(x + 1)*(x + 2)`，使用“一般读入模式”和“预解析读入模式”**都**应当提供原始表达式 `(x + 1)*(x + 2)`。

注意，你提交的输出只需要包含一行，即输出的表达式，**不必包含官方包输出的标签**。

##### 数据限制

- 输入表达式**一定满足**基本概念部分给出的**形式化描述**。
- 输入表达式中**至多包含1层括号**。
- 对于规则 “指数 $\rightarrow$  \*\* 空白项 带符号的整数” ，我们保证**此处的带符号整数中不会出现 - 号**，且保证**输入、计算过程中和最终计算结果得到的指数最大不超过 8**。
- 输入表达式的**有效长度**至多为 **50** 个字符。其中输入表达式的**有效长度**指的是输入表达式去除掉所有**空白符**后剩余的字符总数。（**本条与公测部分的限制不同**）
- 我们会用官方的**基准思路**程序对输入数据进行检验，输出有效长度不超过 **1000** 的视为合法互测数据。（**本条与公测部分的限制不同**）

如果提交的数据不满足上述数据限制，则该数据将被系统拒绝，且不会用来对同屋其他被测程序进行测试。

#### 三、样例

##### 一般读入模式

<table>
    <tr>
        <td><b>#</b></td>
        <td><b>输入</b></td>
        <td><b>输出(省略标签)</b></td>
        <td><b>说明</b></td>
    </tr>
    <tr>
        <td>1</td>
        <td>1</td>
        <td>1</td>
        <td>根据表达式定义可得。</td>
    </tr>
    <tr>
        <td>2</td>
        <td>x</td>
        <td>x</td>
        <td>根据表达式定义可得。</td>
    </tr>
    <tr>
        <td>3</td>
        <td>x+2*x</td>
        <td>x+2*x</td>
        <td>未合并同类项，但表达式依然等价。</td>
    </tr>
    <tr>
        <td>4</td>
        <td>x+2*x</td>
        <td>3*x</td>
        <td>在表达式等价的基础上合并同类项。</td>
    </tr>
    <tr>
        <td>5</td>
        <td>-3*(x)</td>
        <td>-3*x</td>
        <td>拆括号后得到符合输出格式的表达式。</td>
    </tr>
    <tr>
        <td>6</td>
        <td>-3*(x-1)</td>
        <td>-3*x--3*1</td>
        <td>拆括号后得到符合输出格式的表达式。</td>
    </tr>
    <tr>
        <td>7</td>
        <td>(x-1)**2</td>
        <td>x**2-2*x+1</td>
        <td>拆括号后得到符合输出格式的表达式。</td>
    </tr>
    <tr>
        <td>8</td>
        <td>(x+2*x+1)**0</td>
        <td>1</td>
        <td>0 次幂的值为 1。</td>
    </tr>
    <tr>
        <td>9</td>
        <td>(x+1)**3+1</td>
        <td>x**3+3*x**2+3*x+2</td>
        <td>拆括号后得到符合输出格式的表达式。</td>
    </tr>
    <tr>
        <td>10</td>
        <td>(x*x*3*x)**2*x</td>
        <td>x*x*3*x*x*x*3*x*x</td>
        <td>拆括号后得到符合输出格式的表达式。</td>
    </tr>
    <tr>
        <td>11</td>
        <td>(x+1)*(x+2)</td>
        <td>x**2+3*x+2</td>
        <td>把两个不嵌套的括号展开得到结果。</td>
    </tr>
    <tr>
        <td>12</td>
        <td>x*(x-(x+1))</td>
        <td>Wrong Format!（无需输出）</td>
        <td>嵌套括号不会出现在本次作业中。</td>
    </tr>
    <tr>
        <td>13</td>
        <td>(x+y)*x</td>
        <td>Wrong Format!（无需输出）</td>
        <td>多变量表达式不会出现在本次作业中。</td>
    </tr>
</table>

##### 预解析读入模式

<table>
    <tr>
        <td><b>#</b></td>
        <td><b>输入</b></td>
        <td><b>解析后输入</b></td>
        <td><b>输出(省略标签)</b></td>
        <td><b>说明</b></td>
    </tr>
    <tr>
        <td>1</td>
        <td>1</td>
        <td>1 <br /> f1 1</td>
        <td>1</td>
        <td>根据表达式定义可得。</td>
    </tr>
    <tr>
        <td>2</td>
        <td>x</td>
        <td>1 <br /> f1 x</td>
        <td>x</td>
        <td>根据表达式定义可得。</td>
    </tr>
    <tr>
        <td>3</td>
        <td>x+2*x</td>
        <td>2 <br /> f1 mul 2 x <br /> f2 add x f1</td>
        <td>x+2*x</td>
        <td>未合并同类项，但表达式依然等价。</td>
    </tr>
    <tr>
        <td>4</td>
        <td>x+2*x</td>
        <td>2 <br /> f1 mul 2 x <br /> f2 add x f1</td>
        <td>3*x</td>
        <td>在表达式等价的基础上合并同类项。</td>
    </tr>
    <tr>
        <td>5</td>
        <td>-3*(x)</td>
        <td>2 <br /> f1 mul 3 x <br /> f2 neg f1</td>
        <td>-3*x</td>
        <td>拆括号后得到符合输出格式的表达式。</td>
    </tr>
    <tr>
        <td>6</td>
        <td>-3*(x-1)</td>
        <td>3 <br /> f1 sub x 1 <br /> f2 mul 3 f1 <br /> f3 neg f2 </td>
        <td>-3*x--3*1</td>
        <td>拆括号后得到符合输出格式的表达式。</td>
    </tr>
    <tr>
        <td>7</td>
        <td>(x-1)**2</td>
        <td>2 <br /> f1 sub x 1 <br /> f2 pow f1 2</td>
        <td>x**2-2*x+1</td>
        <td>拆括号后得到符合输出格式的表达式。</td>
    </tr>
    <tr>
        <td>8</td>
        <td>(x+2*x+1)**0</td>
        <td>4 <br /> f1 mul 2 x <br /> f2 add x f1 <br /> f3 add f2 1 <br /> f4 pow f3 0</td>
        <td>1</td>
        <td>0 次幂的值为 1。</td>
    </tr>
    <tr>
        <td>9</td>
        <td>(x+1)**3+1</td>
        <td>3 <br /> f1 add x 1 <br /> f2 pow f1 3 <br /> f3 add f2 1</td>
        <td>x**3+3*x**2+3*x+2</td>
        <td>拆括号后得到符合输出格式的表达式。</td>
    </tr>
    <tr>
        <td>10</td>
        <td>(x*x*3*x)**2*x</td>
        <td>5 <br /> f1 mul x x <br /> f2 mul f1 3 <br /> f3 mul f2 x <br /> f4 pow f3 2 <br /> f5 mul f4 x </td>
        <td>x*x*3*x*x*x*3*x*x</td>
        <td>拆括号后得到符合输出格式的表达式。</td>
    </tr>
    <tr>
        <td>11</td>
        <td>(x+1)*(x+2)</td>
        <td>3 <br/> f1 add x 1<br/> f2 add x 2<br/> f3 mul f1 f2<br/></td>
        <td>x**2+3*x+2</td>
        <td>把两个不嵌套的括号展开得到结果。</td>
    </tr>
    <tr>
        <td>12</td>
        <td>x*(x-(x+1))</td>
        <td>3 <br />f1 add x 1 <br /> f2 sub x f1 <br /> f3 mul x f2<br /></td></td>
        <td>Wrong Format!（无需输出）</td>
        <td>嵌套括号不会出现在本次作业中。 </td>
    </tr>
    <tr>
        <td>13</td>
        <td>(x+y)*x</td>
        <td>2<br /> f1 add x y <br /> f2 mul f1 x<br /></td>
        <td>Wrong Format!（无需输出）</td>
        <td>多变量表达式不会出现在本次作业中。</td>
    </tr>
</table>

注意：由于本作业可被判定为正确的答案不唯一，以上样例的输出**仅保证正确性，但并不一定为性能最优解**。

___

### 第七部分：提示与警示

#### 一、提示

* Java 内的原生整数类型有 `long` 和 `int`，长度分别为 64 位和 32 位。
* 如果觉得上述数据类型不够用，可以搜索一下 Java 内可以怎样快速处理这个问题，也可以回顾一下 pre 第 2 弹的指导书。
* **不要重复造轮子！不要重复造轮子！不要重复造轮子！**<del>重要的事情说三遍</del>
* 我们鼓励大家通过 Baidu、Google、Stack Overflow 等方式自行学习和解决问题。
* 如果还有更多的问题，请到讨论区提问。但是**请善用讨论区**，并在此之前认真阅读包括但不限于课程要求文档、指导书、搜索引擎结果等的内容。[关于如何提问](https://www.cnblogs.com/rocedu/p/5167941.html)。

#### 二、警示

- 正式评测时官方包模式选定后的标签输出**会被替换并加密**，因此**请不要尝试 hack 官方输入包**。
- 如果在互测中发现其他人的代码疑似存在**抄袭**或者 **hack 官方包**等行为，可向课程组举报，课程组感谢同学们为 OO 课程建设所作出的贡献。

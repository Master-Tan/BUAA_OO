## 面向对象设计与构造第二单元第一次作业指导书

---

### 第一部分：训练目标

本次作业的基本目标是模拟**多线程实时电梯系统**，熟悉线程的创建、运行等基本操作，熟悉多线程的设计方法

***

### 第二部分：基本概念

- $1、$电梯系统时间 $T_{real}$：从程序开始运行，到所有线程终止，程序结束的时刻花费的时间，即程序的真实运行时间 (real time)
- $2、$电梯系统运行花费总时间 $T_{final}$：从程序开始运行，到电梯最后输出关门的时刻花费的时间
- $3、$开关门窗口时间：从电梯开始开门的时刻到完成关门的时刻的时间闭区间
- $4、$数据基本限制：所有测试数据均需满足的限制
- $5、$公测数据限制：中测和强测数据满足的限制
- $6、$互测数据限制：互测数据需满足的限制

***

### 第三部分：题目描述

#### 一.电梯系统说明

本次作业需要模拟一个多线程实时电梯系统。

系统基于一个类似北京航空航天大学新主楼的大楼，大楼有 $A,B,C,D,E$ ​五个座，每个楼座有对应的一台电梯，可以在楼座内 $1-10$​ 层之间运行。

系统从标准输入中输入请求信息，程序进行接收和处理，模拟电梯运行，将必要的运行信息通过输出接口进行输出。

具体而言，本次作业电梯系统具有的功能为：上下行，开关门，以及模拟乘客的进出。

电梯系统**可以采用任意的调度策略**，即在任意时刻，系统选择上下行动，是否在某层开关门，都可自定义，只要保证在**电梯系统时间不超过系统时间上限**的前提下将所有的乘客送至目的地即可。

电梯每上下运行一层、开关门的时间为固定值，仅在**开关门窗口时间内允许乘客进出**。

**电梯系统默认初始在 $A,B,C,D,E$ 五个楼座的$1$层中各有一个电梯。**

#### 二.电梯参数说明

- $1、$可到达楼层：1 - 10 层
- $2、$初始位置：各座 1 层
- $3、$数量：5 部，A - E 座各一部
- $4、$编号：5 部电梯中 A 座为 1 号，B 座为 2 号，依此类推
- $5、$移动一层花费的时间：0.4s
- $6、$开门花费的时间：0.2s
- $7、$关门花费的时间：0.2s
- $8、$限乘人数：6 人

#### 三.电梯请求说明

本次作业的电梯，为一种比较特殊的电梯，学名叫做**目的选择电梯**。

大概意思是，**在电梯的每个入口，都有一个输入装置，让每个乘客输入自己的目的位置**。电梯基于这样的一个目的地选择系统进行调度，将乘客运送到指定的目标位置。

所以，一个电梯请求包含这个人的**出发楼座、出发楼层、目的楼座和目的楼层**，以及这个人的 id（保证人员 id 唯一），请求内容将作为一个整体送入电梯系统，在整个运行过程中请求内容不会发生改变。

#### 四.电梯捎带规则说明

在**不违反课程规则**的前提下，我们对电梯的**捎带策略不做限制**。希望同学们多多阅读并自行探索相关算法，对电梯的捎带策略有自己的设计与思考。

为保证同学们实现的都为作业要求的**可捎带电梯**，我们对电梯的性能做一定的约束，采用**ALS调度策略**为性能**基准**（关于调度策略，欢迎大家积极上网找资料探索）。性能约束详见公测说明-正确性判断章节中关于 $T_{max}$ 的部分。

#### 五.基准策略

对于每一个电梯，都采用 ALS 策略，即新增**主请求**和**被捎带请求**两个概念

- $1、$主请求选择规则：

  - $(1)、$如果电梯中没有乘客，将请求队列中到达时间最早的请求作为主请求

  - $(2)、$如果电梯中有乘客，将其中到达时间最早的乘客请求作为主请求
- $2、$被捎带请求选择规则：

  - $(1)、$电梯的主请求存在
  - $(2)、$该请求投喂的时刻**小于等于**电梯到达该请求出发楼层关门的截止时间
  - $(3)、$电梯的运行方向和该请求的目标方向一致

***

### 第四部分：输入/输出和样例

#### 一.输入输出接口说明

- $1、$本单元作业使用官方提供的输入输出接口进行输入输出。

- $2、$输入接口提供了若干方法，通过调用方法可以直接获取所需数据对象。输入接口在**尝试**读取标准输入的内容时，对于正确的输入将成功解析，错误的则输出错误信息，但不会影响程序的正常运行。

- $3、$输出子程序接受一个字符串，并附上时间戳后再输出。

- $4、$详细的接口定义和使用方法见官方接口说明文档。

- $5、$程序的输入输出为**实时交互**，评测机可以做到在某个时间点投放一定量的输入。

#### 二.输入数据

每一行是一个乘客的到达信息
* $1、$格式为：`[时间戳]乘客ID-FROM-起点座-起点层-TO-终点座-终点层`
* $2、$输入保证起点层和终点层不同。
* $3、$输入保证起点座和终点座相同。
* $3、$乘客 $ID$ 唯一

#### 三.输出数据

- $1、$通过调用输出接口的每一次输出将自动附加时间戳于头部，具体请参考**输出接口文档**，请不要试图伪造时间戳，否则会在实际评测时产生不一样的结果导致程序运行错误。
- $2、$电梯到达某一位置：`[时间戳]ARRIVE-所在座-所在层-电梯ID`
- $3、$电梯开始开门：`[时间戳]OPEN-所在座-所在层-电梯ID`
- $4、$电梯完成关门：`[时间戳]CLOSE-所在座-所在层-电梯ID`
- $5、$乘客进入电梯：`[时间戳]IN-乘客ID-所在座-所在层-电梯ID`
- $6、$乘客离开电梯：`[时间戳]OUT-乘客ID-所在座-所在层-电梯ID`

#### 四.样例

<table>
    <tr>
        <td>#</td>
        <td>输入</td>
        <td>输出</td>
        <td>说明</td>
    </tr>
    <tr>
        <td width = "100px">1</td>
        <td width = "200px">[0.0]1-FROM-A-1-TO-A-2</td>
        <td width = "300px">[   0.0430]OPEN-A-1-1 <br />[   0.2470]IN-1-A-1-1 <br />[   0.4500]CLOSE-A-1-1 <br />[   0.8670]ARRIVE-A-2-1 <br />[   0.8700]OPEN-A-2-1 <br />[   1.0850]OUT-1-A-2-1 <br />[   1.3000]CLOSE-A-2-1</td>
        <td width = "360px">显然</td>
    </tr>
    <tr>
        <td>2</td>
        <td>[0.0]1-FROM-B-1-TO-B-2 <br />[0.0]2-FROM-B-1-TO-B-2</td>
        <td>[ 0.0120]OPEN-B-1-2 <br />[   0.3160]IN-1-B-1-2 <br />[ 0.3170]IN-2-B-1-2 <br />[ 0.5180]CLOSE-B-1-2 <br />[ 0.9190]ARRIVE-B-2-2 <br />[ 1.1190]OPEN-B-2-2 <br />[ 1.5190]OUT-1-B-2-2 <br />[   1.5200]OUT-2-B-2-2 <br />[ 1.7210]CLOSE-B-2-2</td>
        <td>电梯可以选择在等待一段时间后出发，同时运送乘客1和乘客2</td>
    </tr>
    <tr>
        <td>3</td>
        <td>[1.5]1-FROM-A-1-TO-A-2</td>
        <td>[ 1.3870]OPEN-A-1-1 <br />[ 1.3910]IN-1-A-1-1 <br />[ 1.7930]CLOSE-A-1-1 <br />[ 2.1940]ARRIVE-A-2-1 <br />[ 2.1940]OPEN-A-2-1 <br />[ 2.1940]OUT-1-A-2-1 <br />[ 2.5940]CLOSE-A-2-1</td>
        <td>输入的起始时间可以不从0.0开始（此处存在时间计测同步性问题，在样例说明部分会有详细的说明）</td>
    </tr>
    <tr>
        <td>4</td>
        <td>[2.3]1-FROM-D-2-TO-D-5 <br />[3.6]2-FROM-D-3-TO-D-4</td>
        <td>[ 2.7060]ARRIVE-D-2-4 <br />[ 2.7070]OPEN-D-2-4 <br />[ 2.7100]IN-1-D-2-4 <br />[ 3.1080]CLOSE-D-2-4 <br />[ 3.5120]ARRIVE-D-3-4 <br />[ 3.9120]ARRIVE-D-4-4 <br />[ 4.3130]ARRIVE-D-5-4 <br />[ 4.3140]OPEN-D-5-4 <br />[ 4.3140]OUT-1-D-5-4 <br />[ 4.7140]CLOSE-D-5-4 <br />[ 5.2130]ARRIVE-D-4-4 <br />[ 5.6130]ARRIVE-D-3-4 <br />[ 5.6140]OPEN-D-3-4 <br />[ 5.6140]IN-2-D-3-4 <br />[ 6.0150]CLOSE-D-3-4 <br />[ 6.4160]ARRIVE-D-4-4 <br />[ 6.4160]OPEN-D-4-4 <br />[ 6.4180]OUT-2-D-4-4 <br />[ 6.8170]CLOSE-D-4-4</td>
        <td>第一条请求的所在楼层可以不是1层（此处存在时间计测同步性问题，在样例说明部分会有详细的说明）  <br />电梯在到达5层后折返至3层接乘客2</td>
    </tr>
</table>


说明：

- $1、$为了方便说明，指导书上提供的输入为这样的格式：`[x.x]yyyyyyyy`。
- $2、$意思是在`x.x`这个时刻（相对于程序运行开始的时间，单位秒），输入`yyyyyyyy`这样的一行数据。
- $3、$关于上面说到的**时间计测同步性**问题，在这里解释一下：
  - $(1)、$直观地说，可能会观察到输入指令时间晚于做出反应的时间或反应时间明显晚于预期时间的现象。
  - $(2)、$这个实际上不是程序的错误，而是由于评测机投放数据的系统、和程序输出接口，这两边的时间可能存在不同步导致的。
  - $(3)、$**这一问题是由于多线程测试不可避免的波动性导致的计时同步性误差，属于正常现象，不会被认定为错误**。（<del>当然，也不会出现故意提早的情况，因为程序本身就是实时交互，不可能做得到预知未来</del>）但是，电梯的操作还是应当遵从逻辑，不能出现乘客先进电梯，再开门这样的操作，你的程序所输出的操作的时间戳也应当是递增的。

***

### 第五部分：测试数据限制说明

#### 一.数据基本限制

- $1、$可输入电梯系统的指令数：**1~100条**（指令数为0或超过100均为不合法输入）。
- $2、$系统时间上限 $T_{max}$ ：电梯系统时间 $T_{real}$ 和电梯系统运行花费总时间 $T_{final}$ 的上限时间，**一旦超过将直接判定为TIME_LIMIT_EXCEED**。

#### 二.公测数据限制

- $1、$运行基准时间 $T_{ALS}$：由课程组提供的 `datacheck1` 程序对输入进行分析给出，计算 $T_{ALS}$ 使用的策略为 ALS 调度策略。
- $2、$系统时间上限 $T_{max}$：计算方式为 $T_{max} = \max\left(T_{ALS}+3, 1.05\cdot T_{ALS}\right)$
- $3、$包括强测在内的数据都会保证正常程序的电梯系统时间不会超过 $T_{max}$，也会**避免使用对边界情况较为敏感的数据**。
- $4、$提示：**对于中测和强测数据，$T_{max}$ 将会严格限制为通过上述公式计算得到的值。**<del>所以，请不要试图用超长的 sleep 来回避线程安全停止的问题。</del>

#### 三.互测数据限制

- $1、$系统时间上限 $T_{max}$：对于互测数据，$T_{max}$ 为210s。
- $2、$第一条指令的投喂时间在1s或1s以后。
- $3、$最后一条指令的输入时间不晚于70s。
- $4、$指令条数不超过70。
- $5、$**随测试点提交的输出**中电梯最终的关门时间 $T_{final}$ 不得大于150s。

***

### 第六部分：公测说明

#### 一.正确性判断

程序被认定为正确当且仅当以下 3 个条件同时满足：

- $1、$**代码实现中不存在轮询**。轮询是一种非常占用 CPU 资源的行为，为了避免出现轮询的情况，**请使用 Wait-Notify 的方式编程**。同时，为了检查是否出现轮询的情况，总 CPU 时间限制为 10s，不满足该限制的程序会被判定为错误。

- $2、$**电梯的性能符合基本要求**，即你的程序需要满足 $T_{real} \le T_{max}\ \&\&\ T_{final} \le T_{max}$。这里再次说明 $T_{max}$ 的标准：

  - $(1)、$对于公测数据，$T_{max}$ 取决于 $T_{ALS}$，计算方式为 $T_{max} = \max\left(T_{ALS}+3, 1.05\cdot T_{ALS}\right)$，基准为 ALS 调度策略。
  - $(2)、$对于互测数据，$T_{max}$ 为210s。

- $3、$**输出结果符合逻辑**，具体来说，有以下几点：

  - $(1)、$电梯运行逻辑合理：

    - $a、$电梯到达一层后就可以输出开门信息，然后花 0.2s 开门，开门结束。
    - $b、$电梯开门结束后，某一刻电梯花 0.2s 关门，然后输出关门信息，就可以离开楼层。
    - $c、$电梯在两楼层间若发生移动，应满足移动时间要求
    - $d、$电梯只在可到达楼层运行。
    
  - $(2)、$人员进出逻辑合理：
  
    - $a、$只有已经在电梯里的人可以出电梯，也只有不在电梯里的人可以进入电梯。
  
    - $b、$如果电梯在楼座 A 楼层 2，那么乘客显然也只能在楼座 A 楼层 2 进出。
  
    - $c、$**反常识设定**：开门的 0.2s 期间或关门的 0.2s 期间乘客仍然可以进出，即在**整个开关门窗口时间内**乘客都可以进出。~~纸片人没有厚度~~
  
    - $d、$乘客进出信息在电梯开关门窗口时间之内。
  
        ```java
        错误示例：
        [   4.6280]OUT-1-A-1 ← 这个人没开门就出来了
        [   4.8440]OPEN-A-1
        [   5.0470]CLOSE-A-1
        ```
  
    - $e、$ 电梯系统结束运行时，所有的乘客都到达了目标楼层，且没有被困在电梯里。
  
  - $(3)、$电梯载客量合理：
  
    -   $a、$**电梯任何时候，内部的人数都必须小于等于轿厢容量限制**。
    -   $b、$也就是说，即便在 OPEN、CLOSE 中间，也不允许出现超过容量限制的中间情况。

#### 二.性能分的评判

在强测时，将电梯系统运行花费总时间 $T_{final}$ 作为运行时间 $\rm{time}$ ，计算相应的性能分。
设全体通过该数据点的同学的运行时间的平均值为 $\rm{mean}$ ，标准差为 $\rm{std}$。
设 $x = \frac{\rm{mean}-\rm{time}}{\rm{std}}$，则通过多项式拟合，性能百分比为
$$
r\left(x\right) = 100\% \cdot 
\begin{cases}
1 & x \geq 1 \\\
0.17361111x^3 -0.05952381x^2 +0.73710317x +0.15119048 & -0.2 < x < 1 \\\
0 & x \leq -0.2
\end{cases}
$$

#### 三.分数判定和组成

本次作业功能分为 85 分，性能分为 15 分，二者之和为总分。

***

### 第七部分：互测说明

- $1、$**程序在互测中的正确性判断规则与公测说明中的一致。**
- $2、$所有提交的互测数据均需要满足以下输入格式（该格式与样例一致，可参考样例中的输入格式）：

  + $(1)、$需要携带时间戳 `[time]`，其中 time 是一个保留一位小数的浮点数，比如 `0.0`,`1.5`,`2.2` 等。

  + $(2)、$每行的输入为乘客请求，其格式为 `[<time>]<id>-FROM-<A>-<x>-TO-<B>-<y>`。

  + $(3)、$评测系统将使用请求发射器在对应的时间将请求送入标准输入。
- $3、$所有提交的互测数据均需要满足数据基本限制和互测数据限制。

***

### 第八部分：提示和警示

#### 一、实现提示

- $1、$电梯的"运行策略"实际上可以抽象为从一组待选任务当中选取一个来执行。可以先编写一个**候乘表类**来显示当前电梯系统中各层已有的乘客。再编写一个**策略类**，接受这个候乘表类，分析并输出一个目标位置。因此，分析的过程被隐藏在了策略类内部。
- $2、$将策略类作为电梯的一个属性，通过更换策略类，就可以灵活地切换执行策略。或应用工厂模式组装不同电梯。
- $3、$电梯的运行流程可以抽象为：到达一层→开门→乘客进出→关门→寻找下一目标层→移动，可以使用状态模式建模。

#### 二、其他提示

- $1、$关于接口的一些使用，可以在 idea 里面，按 Ctrl+Q 。将可以看到类和方法的使用格式以及注释（本次官方提供的接口均提供了中文版 javadoc 注释，Ctrl+Q 可以直接查看）

- $2、$请**在代码一开始就初始化时间戳**，否则可能会出现和评测不一致的情况。

    ```java
    import com.oocourse.TimableOutput;
    
    public class MainClass {
      public static void main(String[] args) {
        TimableOutput.initStartTimestamp();  // 初始化时间戳
    		/*
    			代码部分
    		*/
      }
    }

* $3、$官方提供的输出包是**线程不安全**的，需要同学们**自行保证其被多个线程调用时输出符合逻辑**。
* $4、$由于**多线程调度存在随机性**，在使用官方提供的投喂脚本或进行互测环节时，可能会出现**输出与官方评测机不一致、bug 无法复现的情况**，最终结果均**以官方评测机为准**。

#### 三、警示

<font color = red>1. 不要试图Hack评测机和官方接口，不要企图伪造时间戳，不要抄袭。如在互测中发现其他人的代码疑似存在上述行为，可向课程组举报。课程组感谢同学们为OO课程建设所作出的贡献。</font>
